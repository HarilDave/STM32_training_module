#include "stm32l476xx.h"

void delay_us(uint32_t us)
{
    // 16 MHz system clock assumed
    for (uint32_t i = 0; i < us * 16; i++) {
        __NOP();
    }
}

void GPIO_Init(void)
{
    // Enable GPIOA clock
    RCC->AHB2ENR |= RCC_AHB2ENR_GPIOAEN;

    // PA1 -> TRIG (output)
    GPIOA->MODER &= ~(3U << (1 * 2));
    GPIOA->MODER |=  (1U << (1 * 2));

    // PA2 -> ECHO (input)
    GPIOA->MODER &= ~(3U << (2 * 2));
}

void TIM2_Init(void)
{
    RCC->APB1ENR1 |= RCC_APB1ENR1_TIM2EN;

    TIM2->PSC = 16 - 1;   // 1 MHz timer clock (1 Âµs)
    TIM2->ARR = 0xFFFF;   // Max count
    TIM2->CR1 = 1;        // Enable timer
}

uint32_t get_distance_cm(void)
{
    uint32_t start, end, duration;

    // Send 10us trigger pulse
    GPIOA->BSRR = (1 << 1);
    delay_us(10);
    GPIOA->BRR = (1 << 1);

    // Wait for ECHO rising edge
    while (!(GPIOA->IDR & (1 << 2)));

    // Start timer
    TIM2->CNT = 0;

    // Wait for ECHO falling edge
    while (GPIOA->IDR & (1 << 2));

    // Read duration
    duration = TIM2->CNT;

    // Convert to cm (speed of sound = 34300 cm/s)
    return duration / 58;
}

int main(void)
{
    GPIO_Init();
    TIM2_Init();

    uint32_t distance;

    while (1)
    {
        distance = get_distance_cm();
        delay_us(60000); // wait 60ms between readings
    }
}
