#include "stm32l.h"

static void delay_us(uint32_t us)
{
    TIM2->CNT = 0;
    while (TIM2->CNT < us);
}

void delay_ms(uint32_t ms)
{
    for(uint32_t i=0;i<ms;i++)
        delay_us(1000);
}

void GPIO_Init(void)
{
    RCC->AHB2ENR |= (1U << 0);      // Enable GPIOA clock
    GPIOA->MODER &= ~((3U << (2 * 1)) | (3U << (2 * 2))); // Clear PA1, PA2 mode
    GPIOA->MODER |= (1U << (2 * 1)); // PA1 output (TRIG)
    // PA2 input (ECHO)
}

void TIM2_Init(void)
{
    RCC->APB1ENR1 |= (1U << 0);   // Enable TIM2 clock
    TIM2->PSC = 16 - 1;           // 1 MHz -> 1us per tick (assuming 16 MHz clock)
    TIM2->ARR = 0xFFFF;
    TIM2->CR1 = 1;                // Enable counter
}

uint32_t Ultrasonic_Read(void)
{
    uint32_t timeout, start, end;

    // Trigger pulse
    GPIOA->ODR &= ~(1U << 1);
    delay_us(2);
    GPIOA->ODR |= (1U << 1);
    delay_us(10);
    GPIOA->ODR &= ~(1U << 1);

    // Wait for echo high
    timeout = 60000;
    while (!(GPIOA->IDR & (1U << 2))) {
        if (--timeout == 0)
            return 0;  // no echo
    }

    start = TIM2->CNT;

    // Wait for echo low
    timeout = 60000;
    while (GPIOA->IDR & (1U << 2)) {
        if (--timeout == 0)
            return 0;  // echo stuck high
    }

    end = TIM2->CNT;

    if (end >= start)
        return end - start;
    else
        return (0xFFFF - start + end);
}

int main(void)
{
    GPIO_Init();
    TIM2_Init();

    while (1)
    {
        uint32_t time_us = Ultrasonic_Read();
        float distance_cm = time_us * 0.017f; // (speed of sound / 2)
        delay_ms(200);
    }
}
