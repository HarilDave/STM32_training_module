#include "stm32l053xx.h"

#define TX_LEN 13
uint8_t TxBuffer[TX_LEN] = "DMA LOOPBACK";
uint8_t RxBuffer[TX_LEN];

void delay_ms(uint32_t ms)
{
    for (volatile uint32_t i = 0; i < ms * 1000; i++);
}

void UART2_GPIO_Init(void)
{
    RCC->IOPENR |= (1 << 0); // Enable GPIOA clock

    GPIOA->MODER &= ~((3 << (2*2)) | (3 << (3*2)));
    GPIOA->MODER |=  ((2 << (2*2)) | (2 << (3*2))); // AF mode
    GPIOA->AFR[0] &= ~((0xF << (4*2)) | (0xF << (4*3)));
    GPIOA->AFR[0] |=  ((4 << (4*2)) | (4 << (4*3))); // AF4
}

void UART2_DMA_Config(void)
{
    RCC->APB1ENR |= (1 << 17); // USART2 clock
    RCC->AHBENR  |= (1 << 0);  // DMA1 clock

    USART2->BRR = 16000000 / 9600;
    USART2->CR1 |= (1 << 2) | (1 << 3); // RE, TE
    USART2->CR3 |= (1 << 6) | (1 << 7); // DMAR, DMAT
    USART2->CR1 |= (1 << 13);           // UE

    // DMA1 Channel4 = USART2_TX
    DMA1_Channel4->CCR = 0;
    DMA1_Channel4->CPAR  = (uint32_t)&USART2->TDR;
    DMA1_Channel4->CMAR  = (uint32_t)TxBuffer;
    DMA1_Channel4->CNDTR = TX_LEN;
    DMA1_Channel4->CCR   = (1 << 7) | (1 << 4) | (1 << 3); // MEM2PER, MINC, DIR=1

    // DMA1 Channel5 = USART2_RX
    DMA1_Channel5->CCR = 0;
    DMA1_Channel5->CPAR  = (uint32_t)&USART2->RDR;
    DMA1_Channel5->CMAR  = (uint32_t)RxBuffer;
    DMA1_Channel5->CNDTR = TX_LEN;
    DMA1_Channel5->CCR   = (1 << 7) | (1 << 4); // PER2MEM, MINC

    DMA1_Channel5->CCR |= (1 << 0); // Enable RX DMA
}

void UART2_DMA_Transmit(void)
{
    DMA1_Channel4->CCR &= ~(1 << 0);
    DMA1_Channel4->CNDTR = TX_LEN;
    DMA1_Channel4->CCR |= (1 << 0);
}

//int main(void)
//{
//    UART2_GPIO_Init();
//    UART2_DMA_Config();
//    UART2_DMA_Transmit();
//
//    while (!(DMA1->ISR & (1 << 13))); // Wait TX complete
//    DMA1->IFCR |= (1 << 13);          // Clear flag
//
//    RCC->IOPENR |= (1 << 2); // PC8 LED
//    GPIOC->MODER |= (1 << (2*8));
//
//    uint8_t ok = 1;
//    for (int i = 0; i < TX_LEN; i++)
//        if (TxBuffer[i] != RxBuffer[i]) ok = 0;
//
//    while (1)
//    {
//        if (ok)
//            GPIOC->ODR ^= (1 << 8);
//        else
//            GPIOC->ODR |= (1 << 8);
//        delay_ms(300);
//    }
//}

int main(void)
{
    UART2_GPIO_Init();
    UART2_DMA_Config();

    UART2_DMA_Transmit();

    // Wait until DMA TX complete flag (TC4)
    while (!(DMA1->ISR & (1 << 13)));
    DMA1->IFCR |= (1 << 13); // Clear flag

    // At this point, RxBuffer should contain received data.
    // View TxBuffer[] and RxBuffer[] in debugger to verify.
    while (1);
}
