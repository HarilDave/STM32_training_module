#include "stm32l053xx.h"

#define TX_LEN  13
uint8_t TxBuffer[TX_LEN] = "DMA LOOPBACK";
uint8_t RxBuffer[TX_LEN];

void UART2_DMA_Transmit(void)
{
    DMA1_Channel4->CCR &= ~(1 << 0);
    DMA1_Channel4->CNDTR = TX_LEN;
    DMA1_Channel4->CCR |= (1 << 0); // Enable TX DMA
}

int main(void)
{
    UART2_GPIO_Init();
    UART2_DMA_Config();

    UART2_DMA_Transmit();

    // Wait for transfer to complete
    while (!(DMA1->ISR & (1 << 13))); // TCIF4
    DMA1->IFCR |= (1 << 13); // clear flag

    // Small delay
    for (volatile uint32_t d = 0; d < 100000; d++);

    // Verify received data
    uint8_t ok = 1;
    for (int i = 0; i < TX_LEN; i++)
    {
        if (TxBuffer[i] != RxBuffer[i]) ok = 0;
    }

    // Indicate result (toggle LED on PC8 if available)
    RCC->IOPENR |= (1 << 2); // GPIOC clock
    GPIOC->MODER |= (1 << (2*8)); // PC8 output
    while (1)
    {
        if (ok)
            GPIOC->ODR ^= (1 << 8); // success blink
        else
            GPIOC->ODR |= (1 << 8); // solid ON = fail

        for (volatile uint32_t d = 0; d < 300000; d++);
    }
}
