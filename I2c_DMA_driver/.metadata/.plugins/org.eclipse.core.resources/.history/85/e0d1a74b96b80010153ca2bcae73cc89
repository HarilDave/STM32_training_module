#ifndef I2C_DRIVER_H_
#define I2C_DRIVER_H_

#include "STM32_L0538xx.h"


#ifndef I2C_CR1_TXDMAEN
#define I2C_CR1_TXDMAEN   (1U << 15)
#endif

#ifndef I2C_CR1_RXDMAEN
#define I2C_CR1_RXDMAEN   (1U << 14)
#endif

#ifndef RCC_AHBENR_DMA1EN
#define RCC_AHBENR_DMA1EN   (1U << 0)
#endif

#ifndef DMA1
#define DMA1_BASE        (0x40020000UL)
#define DMA1             ((DMA_RegDef_t *)DMA1_BASE)
#endif

typedef struct
{
    uint32_t ClockSpeed;
    uint8_t AddressMode;
    uint16_t OwnAddress;
} I2C_Config_t;

typedef struct
{
    I2C_RegDef_t *Instance;
    I2C_Config_t Init;
} I2C_Handle_t;

#define I2C_7BIT_ADDR   0
#define I2C_10BIT_ADDR  1

#define I2C_WRITE 0
#define I2C_READ  1

void I2C_Init(I2C_Handle_t *hi2c);
void I2C_Start(I2C_Handle_t *hi2c, uint8_t address, uint8_t direction);
void I2C_WriteData(I2C_Handle_t *hi2c, uint8_t data);
uint8_t I2C_ReadData(I2C_Handle_t *hi2c);
void I2C_Stop(I2C_Handle_t *hi2c);

/* ===================================================================== */
/* ========================== DMA REGISTER STRUCT ======================= */
/* ===================================================================== */

/* Minimal DMA register definition for STM32L0xx-like series */
typedef struct
{
    volatile uint32_t CCR;     /* DMA channel configuration register */
    volatile uint32_t CNDTR;   /* Number of data register */
    volatile uint32_t CPAR;    /* Peripheral address register */
    volatile uint32_t CMAR;    /* Memory address register */
    volatile uint32_t RESERVED;
} DMA_Channel_RegDef_t;

typedef struct
{
    volatile uint32_t ISR;     /* Interrupt status register */
    volatile uint32_t IFCR;    /* Interrupt flag clear register */
    DMA_Channel_RegDef_t CH[7]; /* DMA1 has 7 channels typically */
} DMA_RegDef_t;

/* ===================================================================== */
/* ========================== I2C DMA SUPPORT ========================== */
/* ===================================================================== */

typedef struct
{
    DMA_RegDef_t *Instance;      /* DMA controller base (e.g., DMA1) */
    uint32_t Channel;            /* Channel number (1â€“7) */
    uint8_t *Buffer;             /* Pointer to data buffer */
    uint16_t Length;             /* Number of bytes to transfer */
} I2C_DMA_Handle_t;

/* DMA transfer direction */
#define I2C_DMA_TX     0
#define I2C_DMA_RX     1

/* DMA transfer states */
#define I2C_DMA_READY   0
#define I2C_DMA_BUSY    1
#define I2C_DMA_ERROR   2

/* DMA control functions */
void I2C_DMA_Init(I2C_Handle_t *hi2c, I2C_DMA_Handle_t *hdma, uint8_t direction);
void I2C_DMA_Start(I2C_Handle_t *hi2c, I2C_DMA_Handle_t *hdma);
void I2C_DMA_Stop(I2C_Handle_t *hi2c, I2C_DMA_Handle_t *hdma);
void I2C_DMA_IRQHandler(I2C_Handle_t *hi2c, I2C_DMA_Handle_t *hdma);

/* Optional callbacks */
void I2C_DMA_TxCpltCallback(I2C_Handle_t *hi2c);
void I2C_DMA_RxCpltCallback(I2C_Handle_t *hi2c);
void I2C_DMA_ErrorCallback(I2C_Handle_t *hi2c);

#endif /* I2C_DRIVER_H_ */
