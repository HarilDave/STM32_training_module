/*
 * TMP007.c
 *
 *  Created on: Nov 7, 2025
 *      Author: Himshree
 */

#include "TMP007.h"
#include <stdio.h>
#include <string.h>

extern I2C_HandleTypeDef hi2c1;
extern UART_HandleTypeDef huart2;

void TMP007_Scan(void)
{
    char msg[50];
    for (uint8_t addr = 1; addr < 127; addr++)
    {
        if (HAL_I2C_IsDeviceReady(&hi2c1, addr << 1, 1, 10) == HAL_OK)
        {
            sprintf(msg, "Found I2C device at 0x%02X\r\n", addr);
            HAL_UART_Transmit(&huart2, (uint8_t*)msg, strlen(msg), HAL_MAX_DELAY);
        }
    }
}

static uint16_t TMP007_ReadReg(uint8_t reg)
{
    uint8_t buf[2];
    HAL_I2C_Master_Transmit(&hi2c1, TMP007_ADDR << 1, &reg, 1, 100);
    HAL_I2C_Master_Receive(&hi2c1, TMP007_ADDR << 1, buf, 2, 100);
    return (buf[1] << 8) | buf[0];
}

static void TMP007_WriteReg(uint8_t reg, uint16_t val)
{
    uint8_t buf[3];
    buf[0] = reg;
    buf[1] = (val >> 8) & 0xFF;
    buf[2] = val & 0xFF;
    HAL_I2C_Master_Transmit(&hi2c1, TMP007_ADDR << 1, buf, 3, 100);
}

void TMP007_Init(void)
{
    TMP007_WriteReg(TMP007_CONFIG_REG, 0x1000);
    HAL_Delay(500);
}

void TMP007_ReadTemp(void)
{
    uint16_t id = TMP007_ReadReg(0x1F);
    char msg[60];
    sprintf(msg, "TMP007 ID: 0x%04X\r\n", id);
    HAL_UART_Transmit(&huart2, (uint8_t*)msg, strlen(msg), HAL_MAX_DELAY);

    uint16_t raw = TMP007_ReadReg(TMP007_TDIE_REG);
    int16_t temp_raw = (int16_t)raw >> 2;
    float tempC = temp_raw * 0.03125f;

    sprintf(msg, "Temperature: %.2f C\r\n", tempC);
    HAL_UART_Transmit(&huart2, (uint8_t*)msg, strlen(msg), HAL_MAX_DELAY);
}
