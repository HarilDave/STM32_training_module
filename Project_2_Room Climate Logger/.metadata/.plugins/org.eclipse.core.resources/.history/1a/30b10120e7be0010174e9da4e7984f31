#include "BMI160.h"
#include "main.h"
#include <stdio.h>

extern volatile uint32_t *I2C1_CR1;
extern volatile uint32_t *I2C1_CR2;
extern volatile uint32_t *I2C1_ISR;
extern volatile uint32_t *I2C1_TXDR;
extern volatile uint32_t *I2C1_RXDR;
extern volatile uint32_t *USART2_ISR;
extern volatile uint32_t *USART2_TDR;

static void uart2_write(char c) {
    while(!(*USART2_ISR & (1<<7))); // TXE
    *USART2_TDR = c;
}

static void uart2_print(const char *s) {
    while(*s) uart2_write(*s++);
}

static void i2c_write(uint8_t addr, uint8_t reg, uint8_t val) {
    *I2C1_CR2 = (addr<<1) | (1<<16);  // NBYTES=1
    *I2C1_CR2 |= (1<<13);             // START
    while(!(*I2C1_ISR & (1<<1)));     // TXIS
    *I2C1_TXDR = reg;
    while(!(*I2C1_ISR & (1<<6)));     // TC

    *I2C1_CR2 = (addr<<1) | (1<<16);
    *I2C1_CR2 |= (1<<13);
    while(!(*I2C1_ISR & (1<<1)));
    *I2C1_TXDR = val;
    while(!(*I2C1_ISR & (1<<6)));
    *I2C1_CR2 |= (1<<14); // STOP
}

static uint8_t i2c_read(uint8_t addr, uint8_t reg) {
    uint8_t val;
    *I2C1_CR2 = (addr<<1) | (1<<16);
    *I2C1_CR2 |= (1<<13);
    while(!(*I2C1_ISR & (1<<1)));
    *I2C1_TXDR = reg;
    while(!(*I2C1_ISR & (1<<6)));

    *I2C1_CR2 = (addr<<1) | (1<<10) | (1<<16); // RD_WRN=1
    *I2C1_CR2 |= (1<<13);
    while(!(*I2C1_ISR & (1<<2)));
    val = *I2C1_RXDR;
    *I2C1_CR2 |= (1<<14); // STOP
    return val;
}

void BMI160_Init(void) {
    // Wake up accelerometer
    i2c_write(BMI160_ADDR, BMI160_CMD, 0x11);
    for(volatile int i=0;i<400000;i++); // small delay

    // Wake up gyro
    i2c_write(BMI160_ADDR, BMI160_CMD, 0x15);
    for(volatile int i=0;i<400000;i++);
}

void BMI160_ReadAccel(int16_t *ax, int16_t *ay, int16_t *az) {
    uint8_t x_l = i2c_read(BMI160_ADDR, BMI160_ACC_DATA);
    uint8_t x_h = i2c_read(BMI160_ADDR, BMI160_ACC_DATA+1);
    uint8_t y_l = i2c_read(BMI160_ADDR, BMI160_ACC_DATA+2);
    uint8_t y_h = i2c_read(BMI160_ADDR, BMI160_ACC_DATA+3);
    uint8_t z_l = i2c_read(BMI160_ADDR, BMI160_ACC_DATA+4);
    uint8_t z_h = i2c_read(BMI160_ADDR, BMI160_ACC_DATA+5);

    *ax = (int16_t)((x_h<<8)|x_l);
    *ay = (int16_t)((y_h<<8)|y_l);
    *az = (int16_t)((z_h<<8)|z_l);

    char buf[80];
    int len = sprintf(buf,"AX:%d AY:%d AZ:%d\r\n",(int)(*ax),(int)(*ay),(int)(*az));
    uart2_print(buf);
}

void BMI160_ReadGyro(int16_t *gx, int16_t *gy, int16_t *gz) {
    uint8_t x_l = i2c_read(BMI160_ADDR, BMI160_GYR_DATA);
    uint8_t x_h = i2c_read(BMI160_ADDR, BMI160_GYR_DATA+1);
    uint8_t y_l = i2c_read(BMI160_ADDR, BMI160_GYR_DATA+2);
    uint8_t y_h = i2c_read(BMI160_ADDR, BMI160_GYR_DATA+3);
    uint8_t z_l = i2c_read(BMI160_ADDR, BMI160_GYR_DATA+4);
    uint8_t z_h = i2c_read(BMI160_ADDR, BMI160_GYR_DATA+5);

    *gx = (int16_t)((x_h<<8)|x_l);
    *gy = (int16_t)((y_h<<8)|y_l);
    *gz = (int16_t)((z_h<<8)|z_l);

    char buf[80];
    int len = sprintf(buf,"GX:%d GY:%d GZ:%d\r\n",(int)(*gx),(int)(*gy),(int)(*gz));
    uart2_print(buf);
}
