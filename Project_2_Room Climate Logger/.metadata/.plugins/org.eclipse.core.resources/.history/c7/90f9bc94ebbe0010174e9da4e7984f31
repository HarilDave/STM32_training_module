#include "tm007_driver.h"
#include "main.h"   // for hi2c1 and huart2
#include <stdio.h>

extern I2C_HandleTypeDef hi2c1;
extern UART_HandleTypeDef huart2;

static void TMP007_WriteReg(uint8_t reg, uint16_t val)
{
    uint8_t buf[3];
    buf[0] = reg;
    buf[1] = (val >> 8) & 0xFF;
    buf[2] = val & 0xFF;
    HAL_I2C_Master_Transmit(&hi2c1, TMP007_ADDR << 1, buf, 3, 100);
}

static uint16_t TMP007_ReadReg(uint8_t reg)
{
    uint8_t buf[2];
    HAL_I2C_Master_Transmit(&hi2c1, TMP007_ADDR << 1, &reg, 1, 100);
    HAL_I2C_Master_Receive(&hi2c1, TMP007_ADDR << 1, buf, 2, 100);
    return ((uint16_t)buf[0] << 8) | buf[1];
}

void TMP007_Init(void)
{
    TMP007_WriteReg(TMP007_CONFIG_REG, TMP007_CONFIG_RST); // Reset
    HAL_Delay(50);
    TMP007_WriteReg(TMP007_CONFIG_REG, TMP007_CONFIG_CR0); // Normal conversion
    HAL_Delay(100);
}

void TMP007_ReadTemp(void)
{
    uint16_t raw = TMP007_ReadReg(TMP007_TDIE_REG);
    int16_t temp_raw = (int16_t)(raw >> 2);
    float tempC = temp_raw * 0.03125f;

    char buf[50];
    int len = sprintf(buf, "TMP007 Temp: %.2f C\r\n", tempC);
    HAL_UART_Transmit(&huart2, (uint8_t*)buf, len, HAL_MAX_DELAY);
}
