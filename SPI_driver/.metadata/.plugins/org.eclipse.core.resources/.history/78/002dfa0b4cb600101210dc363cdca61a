/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>
#include "spi_driver.h"
#include "gpio_driver.h"
/////////SPI Driver

SPI_Handle_t hspi1;
GPIO_Config_t spi_gpio;
/*
int main(void)
{
    SPI_ClockControl(SPI1, ENABLE);   // 1️⃣ Enable SPI clock

    ////==== Configure SPI GPIO
    spi_gpio.Mode = GPIO_MODE_ALTFN;
    spi_gpio.AltFunc = 0;             // AF0 for SPI1
    spi_gpio.Pull = GPIO_NOPULL;
    spi_gpio.Speed = GPIO_SPEED_HIGH;

    spi_gpio.PinNumber = GPIO_PIN_5;  // SCK
    GPIO_Init(GPIOA, &spi_gpio);

    spi_gpio.PinNumber = GPIO_PIN_6;  // MISO
    GPIO_Init(GPIOA, &spi_gpio);

    spi_gpio.PinNumber = GPIO_PIN_7;  // MOSI
    GPIO_Init(GPIOA, &spi_gpio);

    ////==== Configure Chip Select (CS) pin ====
    spi_gpio.Mode = GPIO_MODE_OUTPUT;
    spi_gpio.PinNumber = GPIO_PIN_4;  // PA4 as CS
    spi_gpio.Pull = GPIO_NOPULL;
    spi_gpio.Speed = GPIO_SPEED_HIGH;
    GPIO_Init(GPIOA, &spi_gpio);

    GPIO_WritePin(GPIOA, GPIO_PIN_4, 1);  // CS HIGH (inactive)

    ///// ==== Configure SPI parameters ====
    hspi1.pSPIx = SPI1;
    hspi1.SPIConfig.DeviceMode = SPI_DEVICE_MODE_MASTER;
    hspi1.SPIConfig.BusConfig = SPI_BUS_FULL_DUPLEX;
    hspi1.SPIConfig.SclkSpeed = SPI_SCLK_DIV8;
    hspi1.SPIConfig.DFF = SPI_DFF_8BIT;
    hspi1.SPIConfig.CPOL = 0;
    hspi1.SPIConfig.CPHA = 0;
    hspi1.SPIConfig.SSM = SPI_SSM_ENABLE;

    SPI_Init(&hspi1);                 // 2️⃣ Configure SPI

    SPI_SSIConfig(SPI1,ENABLE);

    SPI_Enable(SPI1, ENABLE);         // 3️⃣ Enable SPI peripheral

    SPI_PeriClockControl(SPI1, ENABLE);

    uint8_t tx = 0x55;
    uint8_t rx = 0x00;

    ////// ==== Main Loop ====
    while (1)
    {
        GPIO_WritePin(GPIOA, GPIO_PIN_4, 0);   // CS LOW (select slave)

        SPI_SendData(SPI1, &tx, 1);
        SPI_ReceiveData(SPI1, &rx, 1);

        GPIO_WritePin(GPIOA, GPIO_PIN_4, 1);   // CS HIGH (deselect slave)

        for (volatile int i = 0; i < 100000; i++);  // small delay
    }
}
*/

int main(void)
{
    SPI1_PCLK_EN();
    RCC->IOPENR |= (1 << 0);

    GPIOA->MODER &= ~((3 << (5*2)) | (3 << (7*2)));
    GPIOA->MODER |=  ((2 << (5*2)) | (2 << (7*2))); // AF
    GPIOA->AFR[0] &= ~((0xF << (5*4)) | (0xF << (7*4))); // AF0
    GPIOA->AFR[0] |=  ((0x0 << (5*4)) | (0x0 << (7*4)));

    SPI1->CR1 = (1<<2) | (1<<8) | (1<<9) | (1<<6); // MSTR, SSM, SSI, SPE

    while(1)
    {
        while (!(SPI1->SR & (1<<1))); // TXE
        SPI1->DR = 0x55;
        for (volatile int i=0;i<100000;i++);
    }
}

