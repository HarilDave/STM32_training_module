/*
 * spi_driver.h
 * Updated for DMA support
 * Author: Himshree
 */

#ifndef SPI_DRIVER_H_
#define SPI_DRIVER_H_

#include "STM32_L0538xx.h"
#include <stdint.h>

#define SPI_MODE_0   0
#define SPI_MODE_1   1
#define SPI_MODE_2   2
#define SPI_MODE_3   3

#define SPI_DEVICE_MODE_MASTER   1
#define SPI_DEVICE_MODE_SLAVE    0

#define SPI_MASTER_MODE   1
#define SPI_SLAVE_MODE    0

#define SPI_SCLK_DIV2     0
#define SPI_SCLK_DIV4     1
#define SPI_SCLK_DIV8     2
#define SPI_SCLK_DIV16    3
#define SPI_SCLK_DIV32    4
#define SPI_SCLK_DIV64    5
#define SPI_SCLK_DIV128   6
#define SPI_SCLK_DIV256   7

#define SPI_DFF_8BIT   0
#define SPI_DFF_16BIT  1

#define SPI_BUS_FULL_DUPLEX   1
#define SPI_BUS_HALF_DUPLEX   2
#define SPI_BUS_SIMPLEX_RX    3

#define SPI_SSM_DISABLE   0
#define SPI_SSM_ENABLE    1

#define SPI_CPOL_LOW   0
#define SPI_CPOL_HIGH  1
#define SPI_CPHA_LOW   0
#define SPI_CPHA_HIGH  1

#define SPI_SSM_HW   1
#define SPI_SSM_SW   0
#define SPI_SSM_EN   1
#define SPI_SSM_DI   0

typedef struct
{
    uint8_t DeviceMode;
    uint8_t BusConfig;
    uint8_t SclkSpeed;
    uint8_t DFF;
    uint8_t CPOL;
    uint8_t CPHA;
    uint8_t SSM;
} SPI_Config_t;

typedef struct
{
    SPI_RegDef_t *pSPIx;
    SPI_Config_t  SPIConfig;
} SPI_Handle_t;

/* Peripheral Clock */
void SPI_PeriClockControl(SPI_RegDef_t *pSPIx, uint8_t EnOrDi);
void SPI_ClockControl(SPI_RegDef_t *pSPIx, uint8_t EnOrDi);

/* Init / Enable */
void SPI_Init(SPI_Handle_t *pSPIHandle);
void SPI_DeInit(SPI_RegDef_t *pSPIx);
void SPI_Enable(SPI_RegDef_t *pSPIx, uint8_t EnOrDi);

/* Data */
void SPI_SendData(SPI_RegDef_t *pSPIx, uint8_t *pTxBuffer, uint32_t Len);
void SPI_ReceiveData(SPI_RegDef_t *pSPIx, uint8_t *pRxBuffer, uint32_t Len);

/* Flags */
uint8_t SPI_GetFlagStatus(SPI_RegDef_t *pSPIx, uint32_t FlagName);
#define SPI_TXE_FLAG   (1 << 1)
#define SPI_RXNE_FLAG  (1 << 0)
#define SPI_BSY_FLAG   (1 << 7)
#define SPI_CR1_SSI     8

void SPI_SSIConfig(SPI_RegDef_t *pSPIx, uint8_t EnOrDi);

/* ================= DMA SUPPORT ================= */
void SPI1_DMA_Init(uint8_t *txBuf, uint8_t *rxBuf, uint16_t size);
void SPI1_DMA_Start(void);
void SPI1_DMA_Stop(void);

#endif /* SPI_DRIVER_H_ */
